{"version":3,"sources":["./src/services/mainCanvasPlayer.ts"],"sourcesContent":["import { injectable } from 'inversify';\nimport mpegts from 'mpegts.js';\nimport { ImainPlayerService } from '../types/services/index';\nimport Mpegts from 'mpegts.js';\n\n@injectable()\nclass mainPlayerService {\n    private video!: HTMLVideoElement;\n    private canvas!: HTMLCanvasElement;\n    private context!: CanvasRenderingContext2D;\n    private mpegtsPlayer: Mpegts.Player;\n\n    constructor(parmams: { vedio_el: HTMLVideoElement; canvas_el: HTMLCanvasElement }) {\n      this.video = parmams.vedio_el;\n      this.canvas = parmams.canvas_el;\n      if (this.canvas) {\n        this.context = this.canvas.getContext('2d')!;\n      }\n\n      this.video.addEventListener(\n        'play',\n        () => {\n          requestAnimationFrame(this.analyzeCanvas.bind(this));\n        },\n        false,\n      );\n    }\n    createFlvPlayer(parms: Parameters<ImainPlayerService['createFlvPlayer']>[0]) {\n      let { type, isLive, url } = parms;\n      let videoEl = this.video;\n\n      if (videoEl) {\n        this.mpegtsPlayer = mpegts.createPlayer({\n          type: type!, // could also be mpegts, m2ts, flv\n          isLive: isLive,\n          url: url,\n          hasAudio: true,\n        });\n        this.mpegtsPlayer.attachMediaElement(videoEl);\n        this.mpegtsPlayer.load();\n        this.mpegtsPlayer.play();\n\n        this.mpegtsPlayer.on(mpegts.Events.ERROR, (error, detailError) => {\n          if (error === mpegts.ErrorTypes.NETWORK_ERROR) {\n            if (detailError === mpegts.ErrorDetails.NETWORK_UNRECOVERABLE_EARLY_EOF) {\n              this.reoload();\n            }\n            if (detailError === mpegts.ErrorDetails.NETWORK_TIMEOUT) {\n              return false;\n            }\n          }\n        });\n      }\n    }\n\n    setConfig() {\n\n    }\n\n    load() {\n      this.mpegtsPlayer.load();\n    }\n    play() {\n      this.mpegtsPlayer.play();\n    }\n    paused() {\n      this.mpegtsPlayer.pause();\n    }\n\n    reoload() {\n       this.mpegtsPlayer.unload();\n       this.mpegtsPlayer.detachMediaElement();\n       this.mpegtsPlayer.attachMediaElement(this.video);\n      this.mpegtsPlayer.load();\n      this.mpegtsPlayer.play();\n    }\n\n    set_blob_url(filedata: File) {\n      let blobUrl = URL.createObjectURL(filedata);\n      this.video.src = blobUrl;\n      this.video.load();\n    }\n\n    analyzeCanvas() {\n      if (this.video.ended || this.video.paused) {\n        return;\n      }\n\n      this.context.drawImage(\n        this.video,\n        0,\n        0,\n        800,\n        800,\n      );\n\n      const {\n        data: [r, g, b],\n      } = this.context.getImageData(0, 0, 1, 1);\n\n      document.body.style.cssText = `background: rgb(${r}, ${g}, ${b});`;\n      requestAnimationFrame(this.analyzeCanvas.bind(this));\n    }\n  }\n\n\n  export default mainPlayerService;\n\n"],"names":["injectable","mpegts","mainPlayerService","parmams","video","canvas","context","mpegtsPlayer","vedio_el","canvas_el","getContext","addEventListener","requestAnimationFrame","analyzeCanvas","bind","createFlvPlayer","parms","type","isLive","url","videoEl","createPlayer","hasAudio","attachMediaElement","load","play","on","Events","ERROR","error","detailError","ErrorTypes","NETWORK_ERROR","ErrorDetails","NETWORK_UNRECOVERABLE_EARLY_EOF","reoload","NETWORK_TIMEOUT","setConfig","paused","pause","unload","detachMediaElement","set_blob_url","filedata","blobUrl","URL","createObjectURL","src","ended","drawImage","getImageData","data","r","g","b","document","body","style","cssText"],"mappings":"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"}