{"version":3,"sources":["./src/services/b.ts"],"sourcesContent":["/**\n * @author zhangxinxu(.com)\n * @version 1.0.0 2023-05-06\n * @description 让当前Gif图片点击可以暂停播放\n * 如果你有类似需求，基于此实现进行改造\n * 详见：https://www.zhangxinxu.com/wordpress/?p=10830\n *\n * @data {*} data 需要渲染的 GIF 元素，\n * 可以是选择器字符串，\n * 也可以是DOM对象，\n * 或者是 NodeList 对象\n * 也可以省略，会遍历当前页面所有以.gif为后缀的图片元素\n * @returns\n */\n\nconst renderGif = function (data, options) {\n    let objReturn = {\n        element: null,\n        paused: false,\n        play: function () {},\n        pause: function () {},\n        frameIndex: -1,\n    };\n    // 如果浏览器不支持\n    if (typeof ImageDecoder == 'undefined') {\n        console.error('当前浏览器不支持 ImageDecoder API，无法暂停 GIF');\n        return objReturn;\n    }\n    if (typeof data == 'undefined') {\n        data = 'img[src$=\".gif\"]';\n    }\n    if (typeof data == 'string') {\n        data = document.querySelectorAll(data);\n    }\n\n    if (!data) {\n        return objReturn;\n    }\n\n    // 支持 NodeList 对象\n    if (data.forEach) {\n        data.forEach((ele, index) => {\n            const obj = renderGif(ele);\n\n            if (index === 0) {\n                objReturn = obj;\n            }\n        });\n\n        return objReturn;\n    }\n\n    let defaults = {\n        bindEvent: true,\n    };\n\n    const params = Object.assign(defaults, options || {});\n\n    // gif图片的url地址\n    const { src } = data;\n\n    if (!src) {\n        return;\n    }\n\n    const dom = data;\n\n    // 创建的用来播放gif的canvas元素\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n\n    // 一些与GIF播放有关的变量\n    let imageDecoder = null;\n    let imageIndex = 0;\n    let paused = false;\n\n    // 绘制方法\n    const renderImage = function (result) {\n        context.drawImage(result.image, 0, 0);\n\n        const track = imageDecoder.tracks.selectedTrack;\n\n        // 如果播放结束，从头开始循环\n        if (imageDecoder.complete) {\n            if (track.frameCount === 1) {\n                return;\n            }\n\n            if (imageIndex + 1 >= track.frameCount) {\n                imageIndex = 0;\n            }\n        }\n\n        // 绘制下一帧内容\n        imageDecoder\n            .decode({ frameIndex: ++imageIndex })\n            .then((nextResult) => {\n                if (paused === false) {\n                    setTimeout(() => {\n                        renderImage(nextResult);\n                    }, result.image.duration / 1000.0);\n                } else {\n                    canvas.nextResult = nextResult;\n                }\n            })\n            .catch((e) => {\n            // imageIndex可能超出的容错处理\n            if (e instanceof RangeError) {\n                imageIndex = 0;\n                imageDecoder.decode({ frameIndex: imageIndex }).then(renderImage);\n            } else {\n                throw e;\n            }\n        });\n    };\n\n    // 判断地址能够请求\n    fetch(src).then((response) => {\n        // 可以请求，进行样式处理\n        // 设置canvas尺寸\n        canvas.width = dom.naturalWidth;\n        canvas.height = dom.naturalHeight;\n        // 实际显示尺寸\n        canvas.style.width = `${dom.clientWidth}px`;\n        canvas.style.height = `${dom.clientHeight}px`;\n        // 隐藏图片，显示画布\n        dom.after(canvas);\n        dom.style.position = 'absolute';\n        dom.style.opacity = '0';\n\n        // 将GIF绘制在canvas上\n        imageDecoder = new ImageDecoder({\n            data: response.body,\n            type: 'image/gif',\n        });\n        // 解析第一帧并绘制\n        imageDecoder.decode({\n            frameIndex: imageIndex,\n        }).then(renderImage);\n    });\n\n    // 播放和暂停方法\n    const play = function () {\n        paused = false;\n        renderImage(canvas.nextResult);\n    };\n\n    const pause = function () {\n        paused = true;\n    };\n\n    if (params.bindEvent) {\n        // 事件绑定处理\n        dom.addEventListener('click', () => {\n            if (paused) {\n                play();\n            } else {\n                pause();\n            }\n        });\n        canvas.addEventListener('click', () => {\n            if (paused) {\n                play();\n            } else {\n                pause();\n            }\n        });\n    }\n\n    // 返回数据和方法\n    objReturn = {\n        element: data,\n        paused,\n        play,\n        pause,\n        frameIndex: imageIndex,\n    };\n\n    // 几个布尔值和数值属性实时获取\n    Object.defineProperties(objReturn, {\n        paused: {\n            get: function () {\n                return paused;\n            },\n        },\n        frameIndex: {\n            get: function () {\n                return imageIndex;\n            },\n        },\n    });\n\n    return objReturn;\n};"],"names":["renderGif","data","options","objReturn","element","paused","play","pause","frameIndex","ImageDecoder","console","error","document","querySelectorAll","forEach","ele","index","obj","defaults","bindEvent","params","Object","assign","src","dom","canvas","createElement","context","getContext","imageDecoder","imageIndex","renderImage","result","drawImage","image","track","tracks","selectedTrack","complete","frameCount","decode","then","nextResult","setTimeout","duration","catch","e","RangeError","fetch","response","width","naturalWidth","height","naturalHeight","style","clientWidth","clientHeight","after","position","opacity","body","type","addEventListener","defineProperties","get"],"mappings":"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"}