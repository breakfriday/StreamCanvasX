"use strict";(self.webpackChunkstreamcanvasx=self.webpackChunkstreamcanvasx||[]).push([[124],{4621:(e,t,r)=>{r.r(t),r.d(t,{default:()=>a});var n=r(2650),i=r(2157).Z;const a=function(){return i(n.Z,null,(function(){var e=r(2262).Z;return i(e,null)}))}},2262:(e,t,r)=>{r.d(t,{Z:()=>ve});var n=r(2983),i=r(1366),a=r(4965),o=r(808),s=r(1564),c=r(189),u=r(7866),l=r(5368),d=r(1138),v=r(6398),f=r(9513),p=function(){t.isSupported=function(){return!(!window.fetch||!window.ReadableStream)||(console.log("Fetch and Stream API are not supported"),!1)};var e=t.prototype;function t(){(0,d._)(this,"_requestAbort",void 0),(0,d._)(this,"_abortController",void 0),(0,d._)(this,"playerService",void 0),(0,d._)(this,"url",void 0),this.requestAbort=!1}return e.init=function(e,t){this.playerService=e,this.url=t},e.fetchStream=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var r,n,i,a,o;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t,r=new Headers,this._abortController=new AbortController,n={method:"GET",mode:"cors",credentials:"same-origin",headers:r,cache:"default",referrerPolicy:"no-referrer-when-downgrade",signal:this.abortController.signal},e.prev=4,e.next=7,fetch(t,n);case 7:if(i=e.sent,!0!==this.requestAbort){e.next=11;break}return i.body.cancel(),e.abrupt("return");case 11:if(a=i.body,!(o=null==a?void 0:a.getReader())){e.next=16;break}return e.next=16,this.processStream(o);case 16:e.next=20;break;case 18:e.prev=18,e.t0=e.catch(4);case 20:case"end":return e.stop()}}),e,this,[[4,18]])})));return function(t){return e.apply(this,arguments)}}(),e.abortFetch=function(){this.abortController.abort()},e.processStream=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var r,n,i;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=1,e.next=4,t.read();case 4:if(r=e.sent,n=r.done,i=r.value,null==i?void 0:i.buffer,!n){e.next=11;break}return console.log("Stream complete"),e.abrupt("return");case 11:this.playerService.flvVDemuxService.dispatch(i),e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(1),console.error("Error reading stream",e.t0),e.abrupt("return");case 18:e.next=0;break;case 20:case"end":return e.stop()}}),e,this,[[1,14]])})));return function(t){return e.apply(this,arguments)}}(),e.processFlvChunk=function(e){},(0,l.Z)(t,[{key:"requestAbort",get:function(){return this._requestAbort},set:function(e){this._requestAbort=e}},{key:"abortController",get:function(){return this._abortController}}]),t}();const h=p=(0,v.gn)([(0,f.b)()],p);var m=r(8003),g=r(5917),y=r(6517),b=function(){function e(){}var t=e.prototype;return t.on=function(e,t,r){var n=this.e||(this.e={});return(n[e]||(n[e]=[])).push({fn:t,ctx:r}),this},t.once=function(e,t,r){var n=this;function i(){n.off(e,i);for(var a=arguments.length,o=new Array(a),s=0;s<a;s++)o[s]=arguments[s];t.apply(r,o)}return i._=t,this.on(e,i,r)},t.emit=function(e){for(var t=((this.e||(this.e={}))[e]||[]).slice(),r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];for(var a=0;a<t.length;a+=1)t[a].fn.apply(t[a].ctx,n);return this},t.off=function(e,t){var r=this.e||(this.e={});if(!e)return Object.keys(r).forEach((function(e){delete r[e]})),void delete this.e;var n=r[e],i=[];if(n&&t)for(var a=0,o=n.length;a<o;a+=1)n[a].fn!==t&&n[a].fn._!==t&&i.push(n[a]);return i.length?r[e]=i:delete r[e],this},e}();const S=b=(0,v.gn)([(0,f.b)()],b);var x="key",_="delta",I="timeUpdate",D="webcodecsDecodeError",T=12,w="A key frame is required after configure() or flush()",P="Cannot call 'decode' on a closed codec",C=function(e){(0,y.Z)(r,e);var t=r.prototype;function r(){var t;return t=e.call(this)||this,(0,d._)((0,g.Z)(t),"player",void 0),(0,d._)((0,g.Z)(t),"hasInit",void 0),(0,d._)((0,g.Z)(t),"isDecodeFirstIIframe",void 0),(0,d._)((0,g.Z)(t),"isInitInfo",void 0),(0,d._)((0,g.Z)(t),"decoder",void 0),t.hasInit=!1,t.isDecodeFirstIIframe=!1,t.isInitInfo=!1,t.decoder=null,t}return t.init=function(e){this.player=e},t.destroy=function(){this.decoder&&("closed"!==this.decoder.state&&this.decoder.close(),this.decoder=null),this.hasInit=!1,this.isInitInfo=!1,this.isDecodeFirstIIframe=!1,this.off()},t.initDecoder=function(){var e=this;this.decoder=new VideoDecoder({output:function(t){e.handleDecode(t),t.close()},error:function(t){e.handleError(t)}})},t.handleDecode=function(e){this.isInitInfo||(this.isInitInfo=!0),this.player.debugLogService.info({title:"videoFrame",info:e,logkey:"videoFrame"}),this.player.canvasVideoService.render(e)},t.handleError=function(e){console.error(e)},t.decodeVideo=function(e,t,r){if(this.hasInit){if(!this.isDecodeFirstIIframe&&r&&(this.isDecodeFirstIIframe=!0),this.isDecodeFirstIIframe){var n=new EncodedVideoChunk({data:e.slice(5),timestamp:t,type:r?x:_});this.player.emit(I,t);try{if(this.isDecodeStateClosed())return;this.decoder.decode(n)}catch(a){(-1!==a.toString().indexOf(w)||-1!==a.toString().indexOf(P))&&this.player.emit(D)}}}else if(r&&0===e[1]){if((15&e[0])===T)return void console.log("\u4e0d\u652f\u6301 H265");this.player._times.decodeStart||(this.player._times.decodeStart=(new Date).getTime());var i=function(e){for(var t=e.subarray(1,4),r="avc1.",n=0;n<3;n++){var i=t[n].toString(16);i.length<2&&(i="0"+i),r+=i}return{codec:r,description:e}}(e.slice(5));this.decoder.configure(i),this.hasInit=!0}},t.isDecodeStateClosed=function(){return"closed"===this.decoder.state},r}(S);const F=C=(0,v.gn)([(0,f.b)()],C);var E,A=r(6353),Z={videoBuffer:100,videoBufferDelay:100,isResize:!0,isFullResize:!1,isFlv:!1,debug:!1,hotKey:!1,loadingTimeout:10,heartTimeout:5,timeout:10,loadingTimeoutReplay:!0,heartTimeoutReplay:!0,loadingTimeoutReplayTimes:3,heartTimeoutReplayTimes:3,supportDblclickFullscreen:!1,showBandwidth:!1,keepScreenOn:!1,isNotMute:!1,hasAudio:!0,hasVideo:!0,operateBtns:{fullscreen:!1,screenshot:!1,play:!1,audio:!1,record:!1},controlAutoHide:!1,hasControl:!1,loadingText:"",background:"",decoder:"decoder.js",url:"",rotate:0,forceNoOffscreen:!0,hiddenAutoPause:!1,protocol:1,demuxType:"flv",useWCS:!1,wcsUseVideoRender:!0,useMSE:!1,useOffscreen:!1,autoWasm:!0,wasmDecodeErrorReplay:!0,openWebglAlignment:!1,wasmDecodeAudioSyncVideo:!1,recordType:"webm",useWebFullScreen:!1};Math.ceil(40);!function(e){e[e.UseWebGL=0]="UseWebGL",e[e.UseCanvas=1]="UseCanvas",e[e.UseWebGPU=2]="UseWebGPU"}(E||(E={}));var L=r(6269),V=r.n(L);function k(){return(new Date).getTime()}var U=function(e){(0,y.Z)(r,e);var t=r.prototype;function r(t,r,n,i,a,o){var s;return s=e.call(this)||this,(0,d._)((0,g.Z)(s),"httpFlvStreamService",void 0),(0,d._)((0,g.Z)(s),"flvVDemuxService",void 0),(0,d._)((0,g.Z)(s),"webcodecsDecoderService",void 0),(0,d._)((0,g.Z)(s),"canvasVideoService",void 0),(0,d._)((0,g.Z)(s),"debugLogService",void 0),(0,d._)((0,g.Z)(s),"fLVDemuxStream",void 0),(0,d._)((0,g.Z)(s),"mpegtsPlayer",void 0),(0,d._)((0,g.Z)(s),"_stats",void 0),(0,d._)((0,g.Z)(s),"_startBpsTime",void 0),(0,d._)((0,g.Z)(s),"_opt",void 0),(0,d._)((0,g.Z)(s),"_times",void 0),s.httpFlvStreamService=t,s.flvVDemuxService=r,s.webcodecsDecoderService=n,s.canvasVideoService=i,s.debugLogService=a,s.fLVDemuxStream=o,s._opt=Object.assign({},Z),s._times={playInitStart:"",playStart:"",streamStart:"",streamResponse:"",demuxStart:"",decodeStart:"",videoStart:"",playTimestamp:"",streamTimestamp:"",streamResponseTimestamp:"",demuxTimestamp:"",decodeTimestamp:"",videoTimestamp:"",allTimestamp:""},s._stats={buf:0,fps:0,abps:0,vbps:0,ts:0},s}return t.init=function(e){var t=e.model,r=void 0===t?E.UseCanvas:t,n=e.url,i=void 0===n?"":n,a=e.contentEl,o=void 0===a?null:a;this.httpFlvStreamService.init(this,i),this.flvVDemuxService.init(this),this.webcodecsDecoderService.init(this),this.fLVDemuxStream.init(this),this.canvasVideoService.init({parm:r,contentEl:o})},t.createFlvPlayer=function(e){var t=this,r=e.type,n=void 0===r?"flv":r,i=e.isLive,a=void 0===i||i,o=this.httpFlvStreamService.url,s=document.createElement("video");s&&(this.mpegtsPlayer=V().createPlayer({type:n,isLive:a,url:o,hasAudio:!0,hasVideo:!0},{enableStashBuffer:!0,enableWorker:!0,liveBufferLatencyChasing:!0,autoCleanupSourceBuffer:!0,lazyLoad:!1}),this.mpegtsPlayer.attachMediaElement(s),this.mpegtsPlayer.load(),this.mpegtsPlayer.on(V().Events.MEDIA_INFO,(function(e){e.metadata.width,e.metadata.height})),this.mpegtsPlayer.on(V().Events.ERROR,(function(e,r){e===V().ErrorTypes.NETWORK_ERROR&&(t.mpegtsPlayer.unload(),t.mpegtsPlayer.load(),t.mpegtsPlayer.play())})),this.mpegtsPlayer.on(V().Events.STATISTICS_INFO,(function(e){e.speed;t.emit("otherInfo",e)})),this.mpegtsPlayer.on(V().Events.METADATA_ARRIVED,(function(e){t.mpegtsPlayer.play()}))),this.canvasVideoService.createVideoFramCallBack(s)},t.destroy=function(){this.mpegtsPlayer.destroy()},t.log=function(){alert(22)},t.fetchstrean=function(e){this.httpFlvStreamService.fetchStream(e)},t.play=function(e){this.httpFlvStreamService.fetchStream(e)},t.video_render=function(e){var t=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback((function(){t.canvasVideoService.renderFrameByWebgpu(e)}))},t.updateStats=function(e){e=e||{},this._startBpsTime||(this._startBpsTime=k()),e.fps&&(this._stats.fps+=1),e.abps&&(this._stats.abps+=e.abps),e.vbps&&(this._stats.vbps+=e.vbps);var t=k();t-this._startBpsTime<1e3||(this._stats.fps=0,this._stats.abps=0,this._stats.vbps=0,this._startBpsTime=t)},t.retry=function(){this.mpegtsPlayer&&this.mpegtsPlayer.destroy()},t.reload=function(){this.mpegtsPlayer.unload(),this.mpegtsPlayer.load(),this.mpegtsPlayer.play()},r}(S);const R=U=(0,v.gn)([(0,f.b)(),(0,v.fM)(0,(0,A.f)(m.v.IHttpFlvStreamLoader)),(0,v.fM)(1,(0,A.f)(m.v.IFLVDemuxService)),(0,v.fM)(2,(0,A.f)(m.v.IWebcodecsDecoderService)),(0,v.fM)(3,(0,A.f)(m.v.ICanvasVideoService)),(0,v.fM)(4,(0,A.f)(m.v.IDebugLogService)),(0,v.fM)(5,(0,A.f)(m.v.IFLVDemuxStream))],U);var G=1,B=2,W=function(e){(0,y.Z)(r,e);var t=r.prototype;function r(){var t;return t=e.call(this)||this,(0,d._)((0,g.Z)(t),"firstTimestamp",void 0),(0,d._)((0,g.Z)(t),"startTimestamp",void 0),(0,d._)((0,g.Z)(t),"stopId",void 0),(0,d._)((0,g.Z)(t),"delay",void 0),(0,d._)((0,g.Z)(t),"bufferList",void 0),(0,d._)((0,g.Z)(t),"dropping",void 0),(0,d._)((0,g.Z)(t),"player",void 0),t.stopId=null,t.firstTimestamp=null,t.startTimestamp=null,t.delay=-1,t.bufferList=[],window.buff2=t.bufferList,t.dropping=!1,t}return t.init=function(e){this.player=e,this.initInterval()},t.destroy=function(){this.stopId&&(clearInterval(this.stopId),this.stopId=null),this.firstTimestamp=null,this.startTimestamp=null,this.delay=-1,this.bufferList=[],this.dropping=!1,this.off()},t.getDelay=function(e){if(!e)return-1;if(this.firstTimestamp){if(e){var t=Date.now()-this.startTimestamp,r=e-this.firstTimestamp;this.delay=t>=r?t-r:r-t}}else this.firstTimestamp=e,this.startTimestamp=Date.now(),this.delay=-1;return this.delay},t.resetDelay=function(){this.firstTimestamp=null,this.startTimestamp=null,this.delay=-1,this.dropping=!1},t.initInterval=function(){var e=this,t=function(){var t,r=e.player._opt.videoBuffer,n=e.player._opt.videoBufferDelay;if(e.bufferList.length)if(e.dropping){for((t=e.bufferList.shift()).type===G&&0===t.payload[1]&&e._doDecoderDecode(t);!t.isIFrame&&e.bufferList.length;)(t=e.bufferList.shift()).type===G&&0===t.payload[1]&&e._doDecoderDecode(t);t.isIFrame&&e.getDelay(t.ts)<=Math.min(r,200)&&(e.dropping=!1,e._doDecoderDecode(t))}else t=e.bufferList[0],-1===e.getDelay(t.ts)?(e.bufferList.shift(),e._doDecoderDecode(t)):e.delay>r+n?(e.resetDelay(),e.dropping=!0):(t=e.bufferList[0],e.getDelay(t.ts)>r&&(e.bufferList.shift(),e._doDecoderDecode(t)))};t(),this.stopId=setInterval(t,10)},t._doDecode=function(e){var t=e.payload,r=e.type,n=e.ts,i=e.isIFrame,a=e.cts,o=(this.player,{ts:n,cts:a,type:r,isIFrame:!1});r===B&&(o.isIFrame=i,this.pushBuffer(t,o))},t._doDecoderDecode=function(e){var t=this.player.webcodecsDecoderService;e.type===B&&t.decodeVideo(e.payload,e.ts,e.isIFrame)},t.pushBuffer=function(e,t){t.type===G?this.bufferList.push({ts:t.ts,payload:e,type:G}):t.type===B&&this.bufferList.push({ts:t.ts,cts:t.cts,payload:e,type:B,isIFrame:t.isIFrame})},t.close=function(){},r}(S);const M=W=(0,v.gn)([(0,f.b)()],W);var O=1,q=2,N=8,X=9,H=function(e){(0,y.Z)(r,e);var t=r.prototype;function r(){var t;return t=e.call(this)||this,(0,d._)((0,g.Z)(t),"flvDemux",void 0),(0,d._)((0,g.Z)(t),"input",void 0),t.input=t._inputFlv(),t.flvDemux=t.dispatchFlvData(t.input),t}return t.dispatchFlvData=function(e){var t=e.next(),r=null;return function(n){var i=new Uint8Array(n);if(r){var a=new Uint8Array(r.length+i.length);a.set(r),a.set(i,r.length),i=a,r=null}for(;i.length>=t.value;){var o=i.slice(t.value);t=e.next(i.slice(0,t.value)),i=o}i.length>0&&(r=i)}},t.dispatch=function(e){this.flvDemux(e)},t._inputFlv=(0,c.Z)().mark((function e(){var t,r,n,i,a,o,s,u,l,d,v;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,9;case 2:t=new ArrayBuffer(4),r=new Uint8Array(t),n=new Uint32Array(t),i=this.player;case 6:return r[3]=0,e.next=10,15;case 10:return a=e.sent,o=a[4],r[0]=a[7],r[1]=a[6],r[2]=a[5],s=n[0],r[0]=a[10],r[1]=a[9],r[2]=a[8],16777215===(u=n[0])&&(r[3]=a[11],u=n[0]),e.next=23,s;case 23:l=e.sent,e.t0=o,e.next=e.t0===N?27:e.t0===X?29:31;break;case 27:return l.byteLength>0&&this._doDecode({payload:l,type:O,ts:u}),e.abrupt("break",31);case 29:return(i._opt.hasVideo=!0)&&(d=l[0]>>4==1,l.byteLength>0&&(n[0]=l[4],n[1]=l[3],n[2]=l[2],n[3]=0,v=n[0],this._doDecode({payload:l,type:q,ts:u,isIFrame:d,cts:v}))),e.abrupt("break",31);case 31:e.next=6;break;case 33:case"end":return e.stop()}}),e,this)})),r}(M);const j=H=(0,v.gn)([(0,f.b)()],H);var z=r(3669),Y=r.n(z);var K=function(){var e=t.prototype;function t(){(0,d._)(this,"canvas_el",void 0),(0,d._)(this,"canvas_context",void 0),(0,d._)(this,"context2D",void 0),(0,d._)(this,"playerService",void 0),(0,d._)(this,"contextGl",void 0),(0,d._)(this,"device",void 0),(0,d._)(this,"GpuContext",void 0),(0,d._)(this,"renderPipeline",void 0),(0,d._)(this,"regGl",void 0),(0,d._)(this,"useMode",void 0),(0,d._)(this,"sampler",void 0),(0,d._)(this,"contentEl",void 0),(0,d._)(this,"clear",void 0),(0,d._)(this,"loading",void 0),this.canvas_el=document.createElement("canvas")}return e.init=function(e){var t=e||{},r=t.model,n=void 0===r?E.UseCanvas:r,i=t.contentEl;switch(this.setUseMode(n),i&&(this.contentEl=i,this.setCanvasSize(),this.contentEl.append(this.canvas_el)),this.useMode){case E.UseCanvas:this._initContext2D();break;case E.UseWebGL:this.initgl();break;case E.UseWebGPU:this.initGpu()}},e.setUseMode=function(e){this.useMode=e},e.initgl=function(){this.regGl=Y()({canvas:this.canvas_el,extensions:["OES_texture_float"]})},e.drawGl=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var r,n;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,createImageBitmap(t);case 2:e.sent,r=this.regGl.texture(t),n=this.regGl({frag:"\n              precision mediump float;\n              uniform sampler2D texture;\n              varying vec2 uv;\n              void main () {\n                gl_FragColor = texture2D(texture, uv);\n              }\n            ",vert:"\n              precision mediump float;\n              attribute vec2 position;\n              varying vec2 uv;\n              void main () {\n                uv = position;\n                gl_Position = vec4(2.0 * position - 1.0, 0, 1);\n              }\n            ",attributes:{position:[[0,0],[0,1],[1,1],[0,0],[1,1],[1,0]]},uniforms:{texture:r},count:6}),this.regGl.clear({color:[0,0,0,1]}),n(r),r.destroy();case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),e._initContext2D=function(){this.canvas_context=this.canvas_el.getContext("2d")},e.initGpu=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(){var t,r;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator.gpu){e.next=2;break}throw Error("WebGPU not supported.");case 2:return e.next=4,navigator.gpu.requestAdapter();case 4:if(t=e.sent){e.next=7;break}throw Error("Couldn't request WebGPU adapter.");case 7:return e.next=9,t.requestDevice();case 9:this.device=e.sent,this.GpuContext=this.canvas_el.getContext("webgpu"),r=navigator.gpu.getPreferredCanvasFormat(),this.GpuContext.configure({device:this.device,format:r,alphaMode:"premultiplied"}),"@group(0) @binding(0) var mySampler : sampler;\n            @group(0) @binding(1) var myTexture : texture_2d<f32>;\n            \n            struct VertexOutput {\n              @builtin(position) Position : vec4<f32>,\n              @location(0) fragUV : vec2<f32>,\n            }\n            \n            @vertex\n            fn vert_main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\n              const pos = array(\n                vec2( 1.0,  1.0),\n                vec2( 1.0, -1.0),\n                vec2(-1.0, -1.0),\n                vec2( 1.0,  1.0),\n                vec2(-1.0, -1.0),\n                vec2(-1.0,  1.0),\n              );\n            \n              const uv = array(\n                vec2(1.0, 0.0),\n                vec2(1.0, 1.0),\n                vec2(0.0, 1.0),\n                vec2(1.0, 0.0),\n                vec2(0.0, 1.0),\n                vec2(0.0, 0.0),\n              );\n            \n              var output : VertexOutput;\n              output.Position = vec4(pos[VertexIndex], 0.0, 1.0);\n              output.fragUV = uv[VertexIndex];\n              return output;\n            }\n            \n            @fragment\n            fn frag_main(@location(0) fragUV : vec2<f32>) -> @location(0) vec4<f32> {\n              return textureSample(myTexture, mySampler, fragUV);\n            }","@group(0) @binding(1) var mySampler: sampler;\n        @group(0) @binding(2) var myTexture: texture_external;\n        \n        @fragment\n        fn main(@location(0) fragUV : vec2<f32>) -> @location(0) vec4<f32> {\n          return textureSampleBaseClampToEdge(myTexture, mySampler, fragUV);\n        }",this.renderPipeline=this.device.createRenderPipeline({layout:"auto",vertex:{module:this.device.createShaderModule({code:"@group(0) @binding(0) var mySampler : sampler;\n            @group(0) @binding(1) var myTexture : texture_2d<f32>;\n            \n            struct VertexOutput {\n              @builtin(position) Position : vec4<f32>,\n              @location(0) fragUV : vec2<f32>,\n            }\n            \n            @vertex\n            fn vert_main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\n              const pos = array(\n                vec2( 1.0,  1.0),\n                vec2( 1.0, -1.0),\n                vec2(-1.0, -1.0),\n                vec2( 1.0,  1.0),\n                vec2(-1.0, -1.0),\n                vec2(-1.0,  1.0),\n              );\n            \n              const uv = array(\n                vec2(1.0, 0.0),\n                vec2(1.0, 1.0),\n                vec2(0.0, 1.0),\n                vec2(1.0, 0.0),\n                vec2(0.0, 1.0),\n                vec2(0.0, 0.0),\n              );\n            \n              var output : VertexOutput;\n              output.Position = vec4(pos[VertexIndex], 0.0, 1.0);\n              output.fragUV = uv[VertexIndex];\n              return output;\n            }\n            \n            @fragment\n            fn frag_main(@location(0) fragUV : vec2<f32>) -> @location(0) vec4<f32> {\n              return textureSample(myTexture, mySampler, fragUV);\n            }"}),entryPoint:"vert_main"},fragment:{module:this.device.createShaderModule({code:"@group(0) @binding(1) var mySampler: sampler;\n        @group(0) @binding(2) var myTexture: texture_external;\n        \n        @fragment\n        fn main(@location(0) fragUV : vec2<f32>) -> @location(0) vec4<f32> {\n          return textureSampleBaseClampToEdge(myTexture, mySampler, fragUV);\n        }"}),entryPoint:"main",targets:[{format:r}]},primitive:{topology:"triangle-list"}}),this.sampler=this.device.createSampler({magFilter:"linear",minFilter:"linear"});case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e.renderFrameByWebgpu=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var r,n,i,a,o,s;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=(r=this).device.createBindGroup({layout:r.renderPipeline.getBindGroupLayout(0),entries:[{binding:1,resource:this.sampler},{binding:2,resource:this.device.importExternalTexture({source:t})}]}),i=this.device.createCommandEncoder(),a=this.GpuContext.getCurrentTexture().createView(),o={colorAttachments:[{view:a,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]},(s=i.beginRenderPass(o)).setPipeline(this.renderPipeline),s.setBindGroup(0,n),s.draw(6,1,0,0),s.end(),this.device.queue.submit([i.finish()]);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),e.drawFrameByWebgpu=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.setCanvasEL=function(e){this.canvas_el=document.createElement("canvas")},e.setCanvasSize=function(){var e=200,t=400;this.contentEl&&(e=this.contentEl.clientHeight,t=this.contentEl.clientWidth),this.canvas_el.width=t,this.canvas_el.height=e},e._initContextGl=function(){this.contextGl=function(e){for(var t=null,r=["webgl","experimental-webgl","moz-webgl","webkit-3d"],n=0;!t&&n<r.length;){var i=r[n];try{t=e.getContext(i,{preserveDrawingBuffer:!0})}catch(a){t=null}t&&"function"==typeof t.getParameter||(t=null),++n}return t}(this.canvas_el);!function(e,t){var r=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","}"].join("\n"),n=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","const mat4 YUV2RGB = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","void main(void) {","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u = texture2D(uSampler,  textureCoord).r;","highp float v = texture2D(vSampler,  textureCoord).r;","gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n");t&&e.pixelStorei(e.UNPACK_ALIGNMENT,1);var i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||console.log("Vertex shader failed to compile: "+e.getShaderInfoLog(i));var a=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(a,n),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||console.log("Fragment shader failed to compile: "+e.getShaderInfoLog(a));var o=e.createProgram();e.attachShader(o,i),e.attachShader(o,a),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)||console.log("Program failed to compile: "+e.getProgramInfoLog(o)),e.useProgram(o);var s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW);var c=e.getAttribLocation(o,"vertexPos");e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0);var u=e.createBuffer();e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var l=e.getAttribLocation(o,"texturePos");function d(t,r){var n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),e.uniform1i(e.getUniformLocation(o,t),r),n}e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,0,0);var v=d("ySampler",0),f=d("uSampler",1),p=d("vSampler",2)}(this.contextGl,!0)},e.render=function(e){switch(this.useMode){case E.UseCanvas:this.renderCanvas2d(e);break;case E.UseWebGL:this.renderGl(e);break;case E.UseWebGPU:this.renderFrameByWebgpu(e)}},e.renderGl=function(e){var t=this.regGl;this.regGl({frag:"\n            precision mediump float;\n            uniform sampler2D texture;\n            varying vec2 uv;\n            void main () {\n                gl_FragColor = texture2D(texture, uv);\n            }\n            ",vert:"\n            precision mediump float;\n            attribute vec2 position;\n            varying vec2 uv;\n            void main () {\n                uv = position;\n                gl_Position = vec4(1.0 - 2.0 * position, 0, 1);\n            }\n            ",attributes:{position:[[-1,-1],[1,-1],[-1,1],[1,1]]},uniforms:{texture:t.prop("texture")},count:4})},e.renderCanvas2d=function(e){this.canvas_context.drawImage(e,0,0,400,200)},e.getCanvas2dEl=function(){return this.canvas_el},e.createVideoFramCallBack=function(e){var t=this;!function r(){e.requestVideoFrameCallback((function(){t.render(e),r()}))}()},e.clearCanvas=function(){var e=this.canvas_el;this.clear=!0,this.canvas_context.clearRect(0,0,e.width,e.height)},e.drawLoading=function(){var e=this,t=this.canvas_context,r=this.canvas_el,n=0,i=0,a=this;!function o(){var s=r.width/2,c=r.height/2;return!1!==e.loading&&(!0===a.clear?(a.clearCanvas(),!1):(t.clearRect(0,0,r.width,r.height),t.beginPath(),t.arc(s,c,50,0,2*Math.PI),t.lineWidth=10,t.strokeStyle="rgba(200, 200, 200, 0.5)",t.stroke(),t.beginPath(),t.arc(s,c,50,n*Math.PI,i*Math.PI),t.lineWidth=10,t.strokeStyle="rgba(50, 150, 255, 1)",t.stroke(),(n+=.01)>=2&&(n=0),(i+=.02)>=2&&(i=0),void requestAnimationFrame(o)))}()},t}();const J=K=(0,v.gn)([(0,f.b)()],K);const Q={packetLog:!0,videoFrame:!1};var $=function(){var e=t.prototype;function t(){(0,d._)(this,"logConfig",void 0),window.logConfig=Q,this.logConfig=window.logConfig}return e.log=function(e){var t=e.title,r=e.info,n=e.logkey;if(!this.logConfig[n])return!1;console.log(t+": ",r)},e.info=function(e){var t=e.title,r=e.info,n=e.logkey;if(!this.logConfig[n])return!1;console.info(t+":",r)},t}();const ee=$=(0,v.gn)([(0,f.b)()],$);var te=1,re=8,ne=9,ie=15,ae=function(e){(0,y.Z)(r,e);var t=r.prototype;function r(){var t;return t=e.call(this)||this,(0,d._)((0,g.Z)(t),"flvDemux",void 0),(0,d._)((0,g.Z)(t),"input",void 0),(0,d._)((0,g.Z)(t),"flvStream",void 0),(0,d._)((0,g.Z)(t),"streamWriter",void 0),t.createFlvStream(),t}return t.createFlvStream=function(){var e=null,t=new ArrayBuffer(4),r=new Uint8Array(t),n=new Uint32Array(t),i=this,a=!1;this.flvStream=new TransformStream({start:function(e){},transform:function(t,o){var s=new Uint8Array(t);if(e){var c=new Uint8Array(e.length+s.length);c.set(e),c.set(s,e.length),s=c,e=null}if(!1===a&&s.length>=9){s.slice(0,9);s=s.slice(9),a=!0}for(;s.length>=ie;){var u=s.slice(0,ie);r[3]=0;var l=u[4];r[0]=u[7],r[1]=u[6],r[2]=u[5];var d=n[0],v=n[0];if(16777215===v&&(r[3]=u[11],v=n[0]),s.length<d+ie)break;var f=s.slice(ie,d+ie);switch(l){case re:i.processAudioPayload({payload:f,type:te,ts:v});break;case ne:i.processVideoPayload({payload:f,type:te,ts:v,tmp32:n})}(s=s.slice(d+ie)).length>0&&(e=s)}},flush:function(e){console.log("[flush]")}}),this.streamWriter=this.flvStream.writable.getWriter(),this.flvStream.readable.pipeTo(new WritableStream({write:function(e){console.log("Received:",e)},close:function(){console.log("Transformation completed.")}}))},t.parseChunks=function(e,t){},t.processAudioPayload=function(e){var t=e.payload;this.player.debugLogService.log({title:"\u6253\u5370\u97f3\u9891\u5305\u5185\u5bb9",info:t,logkey:"packetLog"})},t.processVideoPayload=function(e){var t=e.payload,r=(e.type,e.ts,e.tmp32);t[0];if(t.byteLength>0){r[0]=t[4],r[1]=t[3],r[2]=t[2],r[3]=0;r[0];this.player.debugLogService.log({title:"\u6253\u5370\u89c6\u9891\u5305\u5185\u5bb9",info:t,logkey:"packetLog"})}},t.dispatch=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.streamWriter.write(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.destroy=function(){this.streamWriter.releaseLock()},r}(M);const oe=ae=(0,v.gn)([(0,f.b)()],ae);s.Zq.bind(m.v.IPlayerService).to(R),s.Zq.bind(m.v.IHttpFlvStreamLoader).to(h),s.Zq.bind(m.v.IWebcodecsDecoderService).to(F),s.Zq.bind(m.v.IFLVDemuxService).to(j),s.Zq.bind(m.v.ICanvasVideoService).to(J),s.Zq.bind(m.v.IDebugLogService).to(ee),s.Zq.bind(m.v.IFLVDemuxStream).to(oe);var se=r(2157).Z,ce=n.useRef,ue=n.useEffect,le=n.useState,de=function(e){var t=ce(null),r=le(),n=r[0],a=r[1];ue((function(){var r,n,i=e.url,c=(r={url:i,contentEl:o.current},(n=s.Zq.get(m.v.IPlayerService)).init(r||{}),n);t.current=c,c.createFlvPlayer({}),c.on("otherInfo",(function(e){var t=e.speed;a({speed:t})}))}),[]);var o=ce(null);return se("div",null,se("div",{style:{width:"200px",height:"200px"},ref:o}),se("div",null,JSON.stringify(n)),se(i.Z,{onClick:function(){t.current.reload()}},"retry"))};const ve=function(){ue((function(){}),[]);var e=le([]),t=e[0],r=e[1];return se("div",null,se(a.Z,{name:"basic",autoComplete:"off",onFinish:function(e){var n={url:e.url},i=Object.assign([],t);i.push(n),r(i)}},se(a.Z.Item,{label:"url",name:"url"},se(o.Z,null)),se(a.Z.Item,{wrapperCol:{offset:8,span:16}},se(i.Z,{type:"primary",htmlType:"submit"},"fetch_play"))),se("div",{style:{display:"flex",flexDirection:"row"}},t.map((function(e,t){var r=e.url;return se(de,{url:r,key:t})}))),se("div",null,"//https://breakfriday.github.io/StreamCanvasX/"))}},1564:(e,t,r)=>{r.d(t,{Fc:()=>i,Zq:()=>a});r(171);var n=r(9768),i=new n.W,a=new n.W},8003:(e,t,r)=>{r.d(t,{v:()=>n});var n={IOriginSerivce:Symbol.for("IOriginSerivce"),IServiceA:Symbol.for("IServiceA"),IAudioProcessingService:Symbol.for("IAudioProcessingService"),IMainPlayerService:Symbol.for("IMainPlayerService"),IPlayerService:Symbol.for("IPlayerService"),IHttpFlvStreamLoader:Symbol.for("IHttpFlvStreamLoader"),IFLVDemuxService:Symbol.for(" IFLVDemuxService"),IWebcodecsDecoderService:Symbol.for("IWebcodecsDecoderService"),ICanvasVideoService:Symbol.for("ICanvasVideoService"),IDebugLogService:Symbol.for("IDebugLogService"),IFLVDemuxStream:Symbol.for("IFLVDemuxStream")}}}]);